#!/bin/bash
# AGNI - God of Fire (Hindu)
# Purification, redemption, burns away impurities, cleanses the system

AGNI_LOG="/var/log/atlas/agni.log"

R='\033[0;31m' G='\033[0;32m' Y='\033[0;33m' O='\033[38;5;208m' N='\033[0m'

log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" >> "$AGNI_LOG"; }

# Purify - clean system of impurities
purify() {
    echo -e "${O}ðŸ”¥ Agni${N} purifying system...\n"

    # Clear package cache
    echo -e "${Y}Package cache:${N}"
    before=$(du -sh /var/cache/pacman/pkg 2>/dev/null | cut -f1)
    pacman -Sc --noconfirm &>/dev/null
    after=$(du -sh /var/cache/pacman/pkg 2>/dev/null | cut -f1)
    echo -e "  ${G}âœ“${N} Cleaned: $before â†’ $after"

    # Clear temp files
    echo -e "\n${Y}Temporary files:${N}"
    find /tmp -type f -atime +3 -delete 2>/dev/null
    find /var/tmp -type f -atime +7 -delete 2>/dev/null
    echo -e "  ${G}âœ“${N} Old temp files burned"

    # Clear journal logs (keep 100MB)
    echo -e "\n${Y}System logs:${N}"
    journalctl --vacuum-size=100M &>/dev/null
    echo -e "  ${G}âœ“${N} Logs trimmed to 100MB"

    # Clear old kernels (keep current)
    echo -e "\n${Y}Old kernels:${N}"
    current=$(uname -r)
    echo -e "  Keeping: $current"

    # Clear thumbnail cache
    echo -e "\n${Y}User caches:${N}"
    rm -rf /home/*/.cache/thumbnails/* 2>/dev/null
    rm -rf /root/.cache/thumbnails/* 2>/dev/null
    echo -e "  ${G}âœ“${N} Thumbnail caches cleared"

    # Clear broken symlinks
    echo -e "\n${Y}Broken symlinks:${N}"
    find /usr/local -xtype l -delete 2>/dev/null
    echo -e "  ${G}âœ“${N} Broken links removed"

    log "System purified"
    echo -e "\n${G}Purification complete${N} ðŸ”¥"
}

# Burn - aggressive cleaning (redemption)
burn() {
    echo -e "${O}ðŸ”¥ Agni${N} BURNING for redemption...\n"

    # Everything in purify
    purify

    # Additional burning
    echo -e "\n${R}Deep cleansing:${N}"

    # Orphan packages
    orphans=$(pacman -Qdtq 2>/dev/null)
    if [[ -n "$orphans" ]]; then
        echo "$orphans" | pacman -Rns --noconfirm - &>/dev/null
        echo -e "  ${G}âœ“${N} Orphan packages removed"
    fi

    # Old log files
    find /var/log -name "*.old" -delete 2>/dev/null
    find /var/log -name "*.gz" -mtime +30 -delete 2>/dev/null
    echo -e "  ${G}âœ“${N} Old logs burned"

    # Pacman cache (keep only 1 version)
    paccache -rk1 &>/dev/null 2>&1 || true
    echo -e "  ${G}âœ“${N} Package cache minimized"

    # Clear shell history (optional)
    # > ~/.bash_history

    log "REDEMPTION: Deep burn completed"
    echo -e "\n${G}Redemption achieved${N} ðŸ”¥"
}

# Consecrate - bless clean files
consecrate() {
    echo -e "${O}ðŸ”¥ Agni${N} consecrating system state...\n"

    # Create clean baseline
    vishnu bless 2>/dev/null && echo -e "  ${G}âœ“${N} File integrity blessed"
    buddha snapshot 2>/dev/null && echo -e "  ${G}âœ“${N} Kernel state blessed"
    kali baseline 2>/dev/null && echo -e "  ${G}âœ“${N} Security baseline blessed"
    viracocha create "consecrated-$(date +%Y%m%d)" 2>/dev/null && echo -e "  ${G}âœ“${N} Backup created"

    log "System consecrated"
    echo -e "\n${G}System consecrated - pure state saved${N}"
}

status_show() {
    echo -e "${O}ðŸ”¥ Agni${N} purity status:"

    # Disk usage
    echo "  Disk: $(df -h / | awk 'NR==2 {print $5 " used"}')"

    # Cache sizes
    echo "  Pacman cache: $(du -sh /var/cache/pacman/pkg 2>/dev/null | cut -f1)"
    echo "  Journal: $(journalctl --disk-usage 2>/dev/null | grep -oP '\d+\.?\d*[GMK]')"
    echo "  /tmp: $(du -sh /tmp 2>/dev/null | cut -f1)"

    # Orphans
    echo "  Orphan packages: $(pacman -Qdtq 2>/dev/null | wc -l)"
}

show_help() {
    cat << 'EOF'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  AGNI - God of Fire (Hindu)                               â•‘
â•‘  Purification & Redemption                                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

USAGE:
  agni <command>

COMMANDS:
  purify       Clean temp files, caches, logs
  burn         Deep cleaning (redemption)
  consecrate   Bless current state as pure
  status       Show purity metrics
  log          Show purification log

"Through fire, we are cleansed"
EOF
}

case "$1" in
    purify|p|"") purify ;;
    burn|b|redemption|r) burn ;;
    consecrate|c|bless) consecrate ;;
    status|st) status_show ;;
    log|l) tail -50 "$AGNI_LOG" 2>/dev/null ;;
    *) show_help ;;
esac
